name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Weekly scan on Saturdays at 21:42 UTC
    - cron: '42 21 * * 6'

permissions:
  contents: read
  pull-requests: read
  security-events: write
  actions: read

jobs:
  # ==============================================================================
  # JOB 1: CHANGE DETECTION (FILTER)
  # ==============================================================================
  filter:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      auth: ${{ steps.filter.outputs.auth }}
      training: ${{ steps.filter.outputs.training }}
      admin: ${{ steps.filter.outputs.admin }}
      swagger: ${{ steps.filter.outputs.swagger }}
      shared: ${{ steps.filter.outputs.shared }}
      is_schedule: ${{ github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'sirius-app/**'
            auth:
              - 'antares-auth/**'
            training:
              - 'aldebaran-training/**'
            admin:
              - 'vega-admin/**'
            swagger:
              - 'bellatrix-swagger/**'
            shared:
              - '.github/workflows/codeql.yml'
              - 'docker-compose.yml'

  # ==============================================================================
  # JOB 2a: ANALYZE ANTARES (AUTH)
  # ==============================================================================
  analyze-auth:
    needs: filter
    # Run if: Scheduled scan OR Auth changes OR Shared config changes
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.auth == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin
          cache: maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          build-mode: manual

      - name: Build Antares Auth
        working-directory: ./antares-auth
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin/auth"

  # ==============================================================================
  # JOB 2b: ANALYZE ALDEBARAN (TRAINING)
  # ==============================================================================
  analyze-training:
    needs: filter
    # Run if: Scheduled scan OR Training changes OR Shared config changes
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.training == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin
          cache: maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          build-mode: manual

      - name: Build Aldebaran Training
        working-directory: ./aldebaran-training
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin/training"

  # ==============================================================================
  # JOB 2c: ANALYZE VEGA (ADMIN)
  # ==============================================================================
  analyze-admin:
    needs: filter
    # Run if: Scheduled scan OR Admin changes OR Shared config changes
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.admin == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin
          cache: maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          build-mode: manual

      - name: Build Vega Admin
        working-directory: ./vega-admin
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin/admin"

  # ==============================================================================
  # JOB 2d: ANALYZE BELLATRIX (SWAGGER)
  # ==============================================================================
  analyze-swagger:
    needs: filter
    # Run if: Scheduled scan OR Swagger changes OR Shared config changes
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.swagger == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: 25
          distribution: temurin
          cache: maven

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          build-mode: manual

      - name: Build Bellatrix Swagger
        working-directory: ./bellatrix-swagger
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin/swagger"

  # ==============================================================================
  # JOB 3: FRONTEND ANALYSIS (JAVASCRIPT/TYPESCRIPT)
  # ==============================================================================
  analyze-javascript:
    needs: filter
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.frontend == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  # ==============================================================================
  # JOB 4: WORKFLOW ANALYSIS (GITHUB ACTIONS)
  # ==============================================================================
  analyze-actions:
    needs: filter
    if: needs.filter.outputs.is_schedule == 'true' || needs.filter.outputs.shared == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: actions
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:actions"